<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KART-V2">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/192/steering-wheel.png">

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <title>KART-OS V2</title>

    <style>
        :root {
            --bg: #050505;
            --primary: #FFD700; /* Jaune */
            --accent: #00ff41;  /* Vert */
            --danger: #ff0040;  /* Rouge */
            --dim: #333;
        }

        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }

        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Orbitron', monospace;
            margin: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- UI STRUCTURE --- */
        #top-bar {
            height: 30px;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 0 10px;
        }

        .led {
            flex: 1;
            height: 15px;
            background: #222;
            border-radius: 2px;
            transform: skewX(-20deg);
        }
        .led.on-green { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .led.on-yellow { background: #ffff00; box-shadow: 0 0 10px #ffff00; }
        .led.on-red { background: #ff0000; box-shadow: 0 0 15px #ff0000; }

        #dashboard {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            padding: 10px;
            gap: 10px;
        }

        .panel {
            background: #0f0f0f;
            border: 2px solid var(--dim);
            border-radius: 12px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
        }

        .label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            text-align: center;
        }

        /* --- SPEEDO --- */
        #speed-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        #speed-val {
            font-size: 110px;
            font-weight: 900;
            line-height: 1;
            text-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        #speed-unit {
            color: var(--primary);
            font-size: 16px;
            margin-top: -10px;
        }

        /* --- G-METER --- */
        #g-box {
            position: relative;
            width: 140px;
            height: 140px;
            border: 1px dashed var(--dim);
            border-radius: 50%;
            background: radial-gradient(circle, #222 2px, transparent 2px);
            background-size: 20px 20px;
            margin: auto;
        }
        #g-puck {
            position: absolute;
            top: 50%; left: 50%;
            width: 16px; height: 16px;
            background: var(--primary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px var(--primary);
            transition: transform 0.1s linear; /* Animation fluide */
        }
        .g-raw { font-size: 9px; color: #444; margin-top: 5px; font-family: monospace; }

        /* --- LAP TIMER --- */
        .time-big { font-size: 30px; color: var(--accent); }
        .time-small { font-size: 14px; color: #888; }
        #btn-lap {
            width: 100%;
            padding: 10px;
            background: var(--dim);
            border: none;
            color: white;
            font-family: inherit;
            margin-top: auto;
            border-radius: 6px;
        }

        /* --- OVERLAYS --- */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        button.start-btn {
            background: var(--primary);
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            font-family: 'Orbitron', monospace;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            margin-top: 20px;
            cursor: pointer;
        }

        .status-msg {
            color: #888;
            font-size: 12px;
            margin-top: 10px;
            max-width: 80%;
        }

    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="color:white; margin:0;">KART-OS V2</h1>
        <p style="color:var(--primary); font-size:12px;">SYSTEM CALIBRATION REQUIRED</p>
        
        <div style="text-align:left; margin: 20px 0; font-size:12px; color:#aaa;">
            1. Fixez le téléphone (Paysage)<br>
            2. Gardez le véhicule IMMOBILE<br>
            3. Appuyez sur START
        </div>

        <button class="start-btn" id="btnStart">CALIBRATE & START</button>
        <div id="debug-log" class="status-msg">En attente...</div>
    </div>

    <div id="top-bar"></div>

    <div id="dashboard">
        
        <div class="panel">
            <div class="label">G-FORCE</div>
            
            <div id="g-box">
                <div style="position:absolute; top:50%; left:0; width:100%; height:1px; background:#333;"></div>
                <div style="position:absolute; top:0; left:50%; width:1px; height:100%; background:#333;"></div>
                <div id="g-puck"></div>
            </div>

            <div style="text-align:center;">
                <div class="value" id="max-g-val" style="font-size:20px; color:white;">0.0 G</div>
                <div class="g-raw" id="raw-sensor">X:0 Y:0</div>
            </div>
        </div>

        <div class="panel">
            <div class="label" id="gps-status">GPS SEARCHING...</div>
            <div id="speed-container">
                <div id="speed-val">0</div>
                <div id="speed-unit">KM/H</div>
            </div>
            <div class="label" id="clock">--:--</div>
        </div>

        <div class="panel">
            <div class="label">LAP TIMER</div>
            <div class="time-big" id="current-lap">00:00.0</div>
            
            <div style="width:100%; margin-top:10px;">
                <div class="label" style="text-align:left;">LAST</div>
                <div class="time-small" id="last-lap">--:--.-</div>
            </div>
            
            <div style="width:100%;">
                <div class="label" style="text-align:left; color:var(--primary);">BEST</div>
                <div class="time-small" id="best-lap" style="color:var(--primary);">--:--.-</div>
            </div>

            <button id="btn-lap">TAP FOR LAP</button>
        </div>

    </div>

    <script>
        const $ = id => document.getElementById(id);
        const log = msg => $('debug-log').innerText = msg;

        // --- LEDS SETUP ---
        const ledContainer = $('top-bar');
        for(let i=0; i<16; i++) {
            let d = document.createElement('div');
            d.className = 'led';
            d.id = 'led-'+i;
            ledContainer.appendChild(d);
        }

        // --- STATE VARS ---
        let calibration = { x: 0, y: 0, z: 0 };
        let isCalibrated = false;
        
        let maxG = 0;
        let speed = 0;
        
        // Timer
        let startTime = 0;
        let lapRunning = false;
        let bestLap = Infinity;

        // --- START & CALIBRATION ---
        $('btnStart').addEventListener('click', async () => {
            log("Demande de permissions...");

            // 1. Permissions iOS
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const resp = await DeviceOrientationEvent.requestPermission();
                    if (resp !== 'granted') {
                        log("Erreur: Permission refusée !");
                        return;
                    }
                } catch (e) {
                    log("Erreur Perm: " + e);
                    return;
                }
            }

            // 2. Active Sensors
            window.addEventListener('devicemotion', handleMotion);
            
            // 3. Active GPS
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(handleGPS, handleGPSError, {
                    enableHighAccuracy: true,
                    maximumAge: 0
                });
            } else {
                $('gps-status').innerText = "NO GPS SUPPORT";
            }

            // 4. Calibration (On attend 500ms pour avoir des données stables)
            log("Calibrage en cours...");
            setTimeout(() => {
                calibrateNow();
                $('overlay').style.display = 'none';
                startLapTimer();
                // Wake Lock
                if(navigator.wakeLock) navigator.wakeLock.request('screen').catch(e=>{});
            }, 1000);
        });

        // --- SENSOR LOGIC ---
        let rawAx = 0, rawAy = 0, rawAz = 0;

        function handleMotion(e) {
            // On utilise accelerationIncludingGravity pour avoir un point de référence stable
            const acc = e.accelerationIncludingGravity;
            if(!acc) return;

            // Filtre passe-bas simple pour lisser (Low Pass Filter)
            rawAx = rawAx * 0.8 + acc.x * 0.2;
            rawAy = rawAy * 0.8 + acc.y * 0.2;
            rawAz = rawAz * 0.8 + acc.z * 0.2;

            if(isCalibrated) {
                updatePhysics(rawAx, rawAy, rawAz);
            }
        }

        function calibrateNow() {
            // On enregistre la position "au repos"
            calibration.x = rawAx;
            calibration.y = rawAy;
            calibration.z = rawAz;
            isCalibrated = true;
            maxG = 0; // Reset Max G
        }

        function updatePhysics(x, y, z) {
            // 1. Calculer la différence par rapport au calibrage (Delta)
            let deltaX = x - calibration.x;
            let deltaY = y - calibration.y;

            // 2. Mapping Paysage (Landscape)
            // En paysage (bouton home à droite), Y est l'axe horizontal, X est l'axe vertical
            // On inverse selon comment le tel est monté, mais généralement :
            // Mouvement Volant (Gauche/Droite) = Axe Y du tel
            // Accélération/Freinage (Haut/Bas) = Axe X du tel
            
            // Note: On inverse deltaX pour que Freinage (accel négative) aille vers le haut (comme sur les vrais G-Meters)
            let gForceX = deltaY / 9.81; // Latéral (G)
            let gForceY = -deltaX / 9.81; // Longitudinal (G)

            // Debug texte (pour voir si ça marche)
            $('raw-sensor').innerText = `X:${gForceX.toFixed(2)} Y:${gForceY.toFixed(2)}`;

            // 3. Update Puck Visual
            // Le cercle fait 140px, rayon 70px.
            // On dit que 1.5G = bord du cercle (70px)
            const scale = 70 / 1.5; 
            
            let drawX = gForceX * scale;
            let drawY = gForceY * scale;

            // Limiter au cercle (Clamping)
            const dist = Math.sqrt(drawX*drawX + drawY*drawY);
            if(dist > 70) {
                drawX = (drawX / dist) * 70;
                drawY = (drawY / dist) * 70;
            }

            // Appliquer la transformation CSS
            $('g-puck').style.transform = `translate(calc(-50% + ${drawX}px), calc(-50% + ${drawY}px))`;

            // 4. Update Max G & LEDs
            let totalG = Math.sqrt(gForceX*gForceX + gForceY*gForceY);
            if(totalG > maxG) {
                maxG = totalG;
                $('max-g-val').innerText = maxG.toFixed(1) + " G";
            }

            updateLeds(totalG);
        }

        function updateLeds(force) {
            // 0G -> 0 LEDs
            // 1G -> Tout allumé
            const maxForce = 1.0; 
            const pct = Math.min(force / maxForce, 1);
            const activeCount = Math.floor(pct * 16);

            for(let i=0; i<16; i++) {
                const led = $('led-'+i);
                led.className = 'led'; // Reset
                if(i < activeCount) {
                    if(i < 6) led.classList.add('on-green');
                    else if(i < 11) led.classList.add('on-yellow');
                    else led.classList.add('on-red');
                }
            }
        }

        // --- GPS LOGIC ---
        function handleGPS(pos) {
            $('gps-status').innerText = "GPS LOCKED ±" + Math.round(pos.coords.accuracy) + "m";
            $('gps-status').style.color = "var(--accent)";
            
            if(pos.coords.speed !== null) {
                // Conversion m/s en km/h
                let kmh = pos.coords.speed * 3.6;
                if(kmh < 1) kmh = 0; // Filtre bruit à l'arrêt
                $('speed-val').innerText = Math.round(kmh);
            }
        }
        function handleGPSError() {
            $('gps-status').innerText = "NO GPS SIGNAL";
            $('gps-status').style.color = "var(--danger)";
        }

        // --- LAP TIMER ---
        function startLapTimer() {
            startTime = Date.now();
            lapRunning = true;
            tick();
        }

        function tick() {
            if(!lapRunning) return;
            const now = Date.now();
            const diff = now - startTime;
            $('current-lap').innerText = formatTime(diff);
            requestAnimationFrame(tick);
        }

        // Gestion du bouton Lap (Tactile complet sur le panel de droite)
        $('btn-lap').addEventListener('click', triggerLap);
        // Ou n'importe où sur le panel Timer
        $('current-lap').parentElement.addEventListener('click', triggerLap);

        function triggerLap() {
            const now = Date.now();
            const lapTime = now - startTime;
            
            // Anti-rebond (éviter double clic) - 5 secondes min
            if(lapTime < 5000) return;

            // Save Lap
            const sTime = formatTime(lapTime);
            $('last-lap').innerText = sTime;

            if(lapTime < bestLap) {
                bestLap = lapTime;
                $('best-lap').innerText = sTime;
                // Flash Vert écran
                document.body.style.backgroundColor = "var(--accent)";
                setTimeout(() => document.body.style.backgroundColor = "var(--bg)", 200);
            }

            // Restart
            startLapTimer();
        }

        function formatTime(ms) {
            let mins = Math.floor(ms / 60000);
            let secs = Math.floor((ms % 60000) / 1000);
            let dsecs = Math.floor((ms % 1000) / 100);
            return `${mins}:${secs.toString().padStart(2,'0')}.${dsecs}`;
        }

        // Clock Update
        setInterval(() => {
            const d = new Date();
            $('clock').innerText = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
        }, 1000);

    </script>
</body>
</html>