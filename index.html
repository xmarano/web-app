<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KART-OS">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/192/f1-race-car-top-veiw.png">

    <!-- Police Racing -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <title>KART-OS Dashboard</title>

    <style>
        :root {
            --bg: #000000;
            --primary: #FFD700; /* Jaune Racing */
            --danger: #FF3333;  /* Rouge Zone */
            --text: #ffffff;
            --dim: #333333;
        }

        * { box-sizing: border-box; touch-action: none; user-select: none; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Message pour forcer le paysage si l'utilisateur est en portrait */
        #rotate-msg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            display: none; /* Géré par JS */
        }

        /* --- LED BAR (Shift Lights) --- */
        #led-bar {
            height: 20px;
            width: 100%;
            display: flex;
            gap: 5px;
            padding: 5px 10px;
            background: #111;
        }
        .led {
            flex: 1;
            background: #222;
            border-radius: 2px;
            transition: background 0.05s;
        }
        .led.active-green { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .led.active-yellow { background: #ffff00; box-shadow: 0 0 10px #ffff00; }
        .led.active-red { background: #ff0000; box-shadow: 0 0 10px #ff0000; }

        /* --- MAIN GRID --- */
        #dashboard {
            flex: 1;
            display: grid;
            grid-template-columns: 25% 50% 25%; /* Gauche - Centre - Droite */
            padding: 10px;
            gap: 10px;
        }

        /* Sections */
        .panel {
            border: 2px solid var(--dim);
            border-radius: 10px;
            background: rgba(20, 20, 20, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            position: relative;
        }

        .label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .value {
            font-size: 24px;
            font-weight: bold;
        }

        /* CENTER SPEEDO */
        .center-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-color: var(--dim);
        }

        #speed-val {
            font-size: 140px; /* Énorme vitesse */
            line-height: 1;
            font-weight: 900;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }
        
        #speed-unit {
            font-size: 20px;
            color: var(--primary);
            margin-top: -10px;
        }

        /* GEAR INDICATOR (Fake) */
        #gear {
            font-size: 40px;
            color: var(--primary);
            background: #222;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 2px solid var(--dim);
        }

        /* G-FORCE CIRCLE */
        #g-canvas {
            width: 100%;
            height: auto;
            aspect-ratio: 1/1;
            background: radial-gradient(circle, #222 1px, transparent 1px);
            background-size: 20px 20px;
            border-radius: 50%;
            border: 1px dashed var(--dim);
        }

        /* LAP TIMER */
        .lap-time { font-size: 32px; color: var(--primary); }
        .last-lap { font-size: 16px; color: #aaa; }
        .best-lap { font-size: 16px; color: var(--primary); }
        
        #lap-btn-hint {
            margin-top: auto;
            background: var(--dim);
            color: white;
            text-align: center;
            padding: 5px;
            font-size: 10px;
            border-radius: 4px;
        }

        /* INFO BAR BOTTOM */
        #info-bar {
            height: 40px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #111;
            font-size: 14px;
            border-top: 1px solid var(--dim);
        }

        .info-item span { color: var(--primary); margin-right: 5px; }

        /* START OVERLAY */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        button {
            background: var(--primary);
            color: black;
            border: none;
            padding: 15px 40px;
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            font-weight: 900;
            text-transform: uppercase;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div id="rotate-msg">⚠️ ROTATE DEVICE TO LANDSCAPE ⚠️</div>

    <div id="overlay">
        <h1 style="color:white; margin-bottom:10px;">KART-OS v1.0</h1>
        <p style="color:#666; margin-bottom:30px;">MOUNT DEVICE SECURELY</p>
        <button id="startBtn">START ENGINE</button>
    </div>

    <!-- LEDS -->
    <div id="led-bar">
        <!-- Générés en JS -->
    </div>

    <div id="dashboard">
        
        <!-- LEFT: G-METER & STATS -->
        <div class="panel">
            <div class="label">G-FORCE</div>
            <canvas id="g-canvas" width="200" height="200"></canvas>
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                <div>
                    <div class="label">MAX G</div>
                    <div class="value" id="max-g">0.0</div>
                </div>
                <div>
                    <div class="label">HEADING</div>
                    <div class="value" id="heading">--</div>
                </div>
            </div>
        </div>

        <!-- CENTER: SPEED -->
        <div class="center-panel">
            <div id="gear">N</div>
            <div id="speed-val">0</div>
            <div id="speed-unit">KM/H</div>
        </div>

        <!-- RIGHT: TIMING -->
        <div class="panel" id="lap-panel">
            <div class="label">CURRENT LAP</div>
            <div class="lap-time" id="current-lap">00:00.0</div>
            
            <div style="margin-top:10px;">
                <div class="label">LAST LAP</div>
                <div class="last-lap" id="last-lap">--:--.-</div>
            </div>
            
            <div style="margin-top:10px;">
                <div class="label">BEST LAP</div>
                <div class="best-lap" id="best-lap">--:--.-</div>
            </div>

            <div id="lap-btn-hint">TAP SCREEN FOR NEW LAP</div>
        </div>

    </div>

    <!-- BOTTOM INFO -->
    <div id="info-bar">
        <div class="info-item"><span>ALT:</span><b id="alt">0m</b></div>
        <div class="info-item"><span>GPS:</span><b id="gps-acc">SEARCHING</b></div>
        <div class="info-item"><span>CLOCK:</span><b id="clock">--:--</b></div>
        <div class="info-item"><span>BAT:</span><b id="batt">--%</b></div>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        
        // --- LED BAR SETUP ---
        const ledContainer = $('led-bar');
        const totalLeds = 15;
        for(let i=0; i<totalLeds; i++) {
            const d = document.createElement('div');
            d.className = 'led';
            d.id = `led-${i}`;
            ledContainer.appendChild(d);
        }

        // --- VARS ---
        let maxG = 0;
        let speedKmh = 0;
        
        // Timer
        let startTime = 0;
        let lapRunning = false;
        let timerInterval;
        let bestLapTime = Infinity;

        // Canvas G-Meter
        const cvs = $('g-canvas');
        const ctx = cvs.getContext('2d');
        let gX = 0, gY = 0;

        // --- START ENGINE ---
        $('startBtn').addEventListener('click', async () => {
            // Wake Lock (Garder l'écran allumé)
            if ('wakeLock' in navigator) {
                try { await navigator.wakeLock.request('screen'); } catch(err) {}
            }

            // Permissions
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try { await DeviceOrientationEvent.requestPermission(); } catch(e) {}
            }

            // Sensors
            window.addEventListener('devicemotion', handleMotion);
            window.addEventListener('deviceorientation', handleOrient);
            
            // GPS
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(handleGPS, null, {
                    enableHighAccuracy: true, maximumAge: 0
                });
            }

            // Battery
            if(navigator.getBattery) {
                navigator.getBattery().then(batt => {
                    updateBatt(batt);
                    batt.addEventListener('levelchange', () => updateBatt(batt));
                });
            }

            // Start Clock
            setInterval(updateClock, 1000);
            
            // Start Lap Timer
            startLap();

            // UI
            $('overlay').style.display = 'none';
            checkOrientation();
            animate();
        });

        function updateBatt(batt) {
            $('batt').innerText = Math.round(batt.level * 100) + "%";
            $('batt').style.color = batt.level < 0.2 ? 'red' : 'white';
        }

        function updateClock() {
            const now = new Date();
            $('clock').innerText = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
        }

        // --- SENSOR LOGIC ---

        function handleGPS(pos) {
            const crd = pos.coords;
            
            // Speed conversion m/s -> km/h
            if(crd.speed !== null) {
                speedKmh = crd.speed * 3.6;
                if(speedKmh < 0) speedKmh = 0; // Fix negative speed noise
                
                // Display Speed
                $('speed-val').innerText = Math.round(speedKmh);
                
                // Fake Gear Logic
                let gear = 'N';
                if(speedKmh > 0 && speedKmh < 15) gear = '1';
                else if(speedKmh >= 15 && speedKmh < 35) gear = '2';
                else if(speedKmh >= 35 && speedKmh < 60) gear = '3';
                else if(speedKmh >= 60 && speedKmh < 90) gear = '4';
                else if(speedKmh >= 90) gear = '5';
                $('gear').innerText = gear;
            }

            $('alt').innerText = Math.round(crd.altitude || 0) + "m";
            $('gps-acc').innerText = "±" + Math.round(crd.accuracy) + "m";
            
            // Color code precision
            $('gps-acc').style.color = crd.accuracy < 10 ? 'var(--primary)' : 'red';
        }

        function handleOrient(e) {
            // Compass heading
            let h = e.webkitCompassHeading || (360 - e.alpha);
            if(h) {
                const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
                const idx = Math.round(h / 45) % 8;
                $('heading').innerText = dirs[idx];
            }
        }

        function handleMotion(e) {
            const acc = e.acceleration;
            if(!acc) return;

            // Simple low pass filter
            gX = gX * 0.8 + (acc.x || 0) * 0.2;
            gY = gY * 0.8 + (acc.y || 0) * 0.2;

            // Calcul intensité totale pour les LEDs et Max G
            const totalG = Math.sqrt(gX*gX + gY*gY) / 9.81;
            
            if(totalG > maxG) {
                maxG = totalG;
                $('max-g').innerText = maxG.toFixed(1) + "G";
            }

            updateLeds(totalG);
        }

        // --- VISUALS ---

        function updateLeds(forceG) {
            // Sensibilité : 1.0G allume tout
            const intensity = Math.min(forceG / 0.8, 1); 
            const ledsOn = Math.floor(intensity * totalLeds);

            for(let i=0; i<totalLeds; i++) {
                const el = document.getElementById(`led-${i}`);
                if(i < ledsOn) {
                    if(i < 5) el.className = 'led active-green';
                    else if(i < 10) el.className = 'led active-yellow';
                    else el.className = 'led active-red';
                } else {
                    el.className = 'led';
                }
            }
        }

        function drawGMeter() {
            // Clear
            ctx.clearRect(0, 0, 200, 200);
            
            // Center
            const cx = 100;
            const cy = 100;

            // Draw Crosshair
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, 200); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(200, cy); ctx.stroke();

            // Draw Dot (Ball)
            // Note: X/Y from accel are often reversed depending on device orientation
            // We assume landscape (Left/Right is Y, Top/Bottom is X usually)
            // Scaling: 10m/s^2 = edge of circle (radius 100)
            const scale = 8; 
            
            // Inversion might be needed based on how phone is mounted
            // Assuming phone top is facing left (home button right)
            const drawX = cx - (gY * scale); 
            const drawY = cy - (gX * scale);

            ctx.beginPath();
            ctx.arc(drawX, drawY, 8, 0, Math.PI*2);
            ctx.fillStyle = 'var(--primary)';
            ctx.fill();
            
            // Trail logic could be added here
        }

        // --- LAP TIMER ---
        
        function startLap() {
            startTime = Date.now();
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const delta = Date.now() - startTime;
                $('current-lap').innerText = formatTime(delta);
            }, 50); // 50ms refresh for performance
        }

        function formatTime(ms) {
            const min = Math.floor(ms / 60000);
            const sec = Math.floor((ms % 60000) / 1000);
            const dec = Math.floor((ms % 1000) / 100);
            return `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}.${dec}`;
        }

        // Tap screen to trigger lap
        document.body.addEventListener('touchstart', (e) => {
            // Ignorer si on clique sur le bouton Start
            if(e.target.id === 'startBtn') return;
            
            const delta = Date.now() - startTime;
            
            // Ignorer double tap accidentel (< 5 secondes)
            if(delta < 5000) return;

            // Enregistrer Lap
            const timeStr = formatTime(delta);
            $('last-lap').innerText = timeStr;
            
            if(delta < bestLapTime) {
                bestLapTime = delta;
                $('best-lap').innerText = timeStr;
                // Flash vert pour meilleur tour
                document.body.style.background = '#004400';
                setTimeout(() => document.body.style.background = 'var(--bg)', 200);
            } else {
                // Flash normal
                document.body.style.background = '#333';
                setTimeout(() => document.body.style.background = 'var(--bg)', 100);
            }

            startLap();
        });

        // --- LOOP ---
        function animate() {
            drawGMeter();
            requestAnimationFrame(animate);
        }

        // --- ORIENTATION CHECK ---
        function checkOrientation() {
            if(window.innerHeight > window.innerWidth) {
                $('rotate-msg').style.display = 'flex';
            } else {
                $('rotate-msg').style.display = 'none';
            }
        }
        window.addEventListener('resize', checkOrientation);

    </script>
</body>
</html>